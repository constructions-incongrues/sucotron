.PHONY=help release test

SHELL=/bin/bash

IMAGE=constructionsincongrues/sucotron
VERSION=

help: ## Affiche ce message d'aide. Une documentation détaillée est disponible à l'adresse suivante : https://github.com/constructions-incongrues/sucotron
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

release: ## Crée un nouveau tag Git et le diffuse
	git fetch --all -p
	git checkout develop
	git pull origin develop
	sed -i "s/^SUCOTRON_VERSION=.*/SUCOTRON_VERSION=$(VERSION)/g" .env
	git add .env
	git commit -m "[release] Sortie de la version $(VERSION)"
	git checkout master
	git merge master origin/master
	git merge develop
	git tag $(VERSION)
	git push origin develop master --tags
	git checkout develop
	sed -i "s/^SUCOTRON_VERSION=.*/SUCOTRON_VERSION=develop/g" .env
	git add .env
	git commit -m "[release] Retour en mode développement"

test: ## Exécute les tests automatisés
	TEST_ID=`< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c6`; \
	make queries COLLECTION="test$$TEST_ID"; \
	echo "Jean Yann - Chobibi" > "./collections/test$$TEST_ID/queries.txt"; \
	echo "Sabine Paturelle Les bêtises" >> "./collections/test$$TEST_ID/queries.txt"; \
	make suce COLLECTION="test$$TEST_ID"; \
	make clean COLLECTION="test$$TEST_ID" FORCE=yes; \
	make help; \
	rm -r "./collections/test$$TEST_ID"
